# Shiny modules

Functions work well if:

- All code is on the server side
- All code in on the client side

<br>

If the **server code relies** on specific structure in the **UI**

- Use **modules**

## Without modules {-}

We can end creating a really hard to mantain app.

![](images/19-modules/01-before-modules.png){width=50% height=50%}

## Modules benefits {-}

Modules are a kind of **miniature app** within a larger app that isolate a particular group of **inputs and outputs** with a UI and a server part. 

- Avoid namespace collisions
- Allows encapsulate distinct app components
- Facilities collaboration

- **Modules works as functions for Shiny**.
  - Helps you break your big, complex app into smaller parts. 
  - Makes Shiny code more readable.
  - Makes Shiny code easier to debug.
  - Makes Shiny components reusable.
  - Opens the possibility to apply unit test.
  
  
## After implementing modules {-}

![](images/19-modules/02-after-modules.png){width=50% height=50%}


## Simple histogram app {-}

```{r, eval=FALSE}
ui <- fluidPage(
  selectInput("var", "Variable", names(mtcars)),
  numericInput("bins", "bins", 10, min = 1),
  plotOutput("hist")
)
server <- function(input, output, session) {
  data <- reactive(mtcars[[input$var]])
  output$hist <- renderPlot({
    hist(data(), breaks = input$bins, main = input$var)
  }, res = 96)
}
```

## Creating UI function {-}

1. Create a function with the `id` argument.
2. Wrap all components in the `tagList` function to **bundle together multiple components** without actually implying how they’ll be laid out. 
3. Wrap each `inputId` using the next structure `NS(id, "id_name")`.

```{r, eval=FALSE}
histogramUI <- function(id) {
  tagList(
    selectInput(NS(id, "var"), "Variable", choices = names(mtcars)),
    numericInput(NS(id, "bins"), "bins", value = 10, min = 1),
    plotOutput(NS(id, "hist"))
  )
}
```

## Using NS once {-}

From `shiny::NS()` documentation.

> If id is missing, returns a function that expects an id string as its only argument and returns that id with the namespace prepended. 

```{r eval=FALSE}
histogramUI <- function(id) {
  ns <- NS(id)
  tagList(
    selectInput(ns("var"), "Variable", choices = names(mtcars)),
    numericInput(ns("bins"), "bins", value = 10, min = 1),
    plotOutput(ns("hist"))
  )
}
```

## Module server {-}

1. Create a function with the ID argument.
2. Call the `shiny::moduleServer()` and pass the id and a **function that looks like a regular server function**.

**Note:** Thanks to that `id` the `shiny::moduleServer()` will be able to bring the **inputs** and **outputs** created in the UI function.

```{r eval=FALSE}
histogramServer <- function(id) {
  moduleServer(id, function(input, output, session) {
    data <- reactive(mtcars[[input$var]])
    output$hist <- renderPlot({
      hist(data(), breaks = input$bins, main = input$var)
    }, res = 96)
  })
}
```


## Confirm that the model works {-}

We can create a custom function to validate that each modele is working.

```{r eval=FALSE}
histogramApp <- function() {
  ui <- fluidPage(
    histogramUI("hist1")
  )
  server <- function(input, output, session) {
    histogramServer("hist1")
  }
  shinyApp(ui, server)  
}
```

## Confirm that the model works (Shinylive) {-}

<iframe height="500" width="100%" frameborder="no" src="https://shinylive.io/r/app/#code=NobwRAdghgtgpmAXGKAHVA6ASmANGAYwHsIAXOMpMAGwEsAjAJykYE8AKAZwAtaJWAlAB0IIgMQACALJEAJgFdqcTiJG9OpIgHNmMAKoBJCQB4AtBIBm8iAVK0S7WrIESQIiRIicT5gHIBlR2d3CVIoLQAZWg12EI9OOCVbAwhUeVJ2L1iwADcWITABXAkCgDUWWih6JQLigm4iWgJlCQBeT1hldhhSAhZOASK4z3l4RiaUtIysgvo+FULi2fnaiTzqeTg2iQBGAAZimD5tnaGIDw9UaiJSAHl0qczObPVSAsGQ4QgAX1UIV+0un8cEYORBPks1ls9ggQRcbnOEhgckUcGBoJBQWKVhsdgcfCmxSID3SxQSnE4MPhw1kUDCEMYcCg0LB3V6-WAwAJ6QAJHlGABdAVfC4SYmkKY814MiiyEEABWuGQRoo8r3YtLC7CKEiYTIA1t52tzSDy5l5DlBjsbUrz+SKLt9ioyjRIAJwANgd3y+v1E-skUit5zQqD+AJ0sAAgugITjoQ5qYj5LQ4xsnPLwnBYoi1dFNJH9AYXvmdu9PiEEhjGHGoXjYSaiSTSGTlJSSEnRRGgSCwYwSxoy4UQn74rx+DHUOwU63qy4Sj8-pIsNYJKHw-nAdH0NqwN8BUA"> </iframe>

## Modules isolation {-}

- `output$out` will never get updated because there is no input$bins
- The bins input can only be seen inside of the **hist1 module**.

```{r eval=FALSE}
ui <- fluidPage(
  histogramUI("hist1"),
  textOutput("out")
)
server <- function(input, output, session) {
  histogramServer("hist1")
  output$out <- renderText(paste0("Bins: ", input$bins))
}
```

## Modules conventions {-}

- `R/histogram.R` holds all the code for the module.

- `histogramUI()` is the module UI. If it’s used primarily for input or output I’d call it `histogramInput()` or `histogramOuput()` instead.

- `histogramServer()` is the module server.

- `histogramApp()` creates a complete app for interactive experimentation and more formal testing.

## Exercise 1 {-}

**Why is it good practice to put a module in its own file in the R/ directory? What do you need to do to make sure it’s loaded by your Shiny app?**

- I makes easier to transform the shiny app in to a package, as all the functions in a R package are store in the R/ folder.

- We will need to `source()` each of the modules.

```{r eval=FALSE}
sourceDir <- function(path, trace = TRUE, ...) {
    op <- options(); on.exit(options(op)) # to reset after each
    for (nm in list.files(path, pattern = "[.][RrSsQq]$")) {
       if(trace) cat(nm,":")
       source(file.path(path, nm), ...)
       if(trace) cat("\n")
       options(op)
    }
}
```

## Exercise 2 {-}

**The following module UI includes a critical mistake. What is it and why will it cause problems?**

```{r, eval=FALSE}
histogramUI <- function(id) {
  tagList(
    selectInput("var", "Variable", choices = names(mtcars)),
    numericInput("bins", "bins", value = 10, min = 1),
    plotOutput("hist")
  )
}
```

## Exercise 2 {-}

We need to use the `shiny::NS()` function to define the ids.

```{r, eval=FALSE}
histogramUI <- function(id) {
  ns <- NS(id)
  tagList(
    selectInput(ns("var"), "Variable", choices = names(mtcars)),
    numericInput(ns("bins"), "bins", value = 10, min = 1),
    plotOutput(ns("hist"))
  )
}
```


## Exercise 3 {-}

**The following module generates a new random number every time you click go:**

```{r eval=FALSE}
randomUI <- function(id) {
  tagList(
    textOutput(NS(id, "val")),
    actionButton(NS(id, "go"), "Go!")
  )
}

randomServer <- function(id) {
  moduleServer(id, function(input, output, session) {
    rand <- eventReactive(input$go, sample(100, 1))
    output$val <- renderText(rand())
  })
}
```

## Exercise 3 {-}

**Create an app that displays four copies of this module on a single page. Verify that each module is independent.**

```{r eval=FALSE}
ui <- fluidPage(
    randomUI("num1"),
    randomUI("num2"),
    randomUI("num3"),
    randomUI("num4")
)

server <- function(input, output, session) {
    randomServer("num1")
    randomServer("num2")
    randomServer("num3")
    randomServer("num4")
}

shinyApp(ui, server)  
```

## Exercise 3 (Shinylive) {-}

<iframe height="500" width="100%" frameborder="no" src="https://shinylive.io/r/app/#code=NobwRAdghgtgpmAXGKAHVA6ASmANGAYwHsIAXOMpMAGwEsAjAJykYE8AKAZwAtaJWAlAB0IIgMQACALJEAJgFdqcTiJHMIsojACqASQkAeALQSAZvIgFStEu1qyBEkCIkTSUAOYAZWp1LsXVzc4AA9SAHl5UlQo9gA5AGU7WVwJITAANyhqdIEBXEDXKCsbCAAhKNJbROTU9I8iXLqwAHEiAEJcwOEIAF81KA0tBLhGDNHDE3NLa1t7R2cIVxg5RTgRsdHaswsSuYgY0lSiKMPUzmVOUoXCiXVZSYk4cbIsOGLrcbsDqIASBvOsFQSnYAEYAAzg1KgvK3E7RP5ZaiPRgUWSjAAqoX893YsKWEl6PX6olJkikUD4EjQqFUEHktEepmoDNkAAVPHAAgTXPctHoApB5DBQU1bnydLpBfSYAAmMU8u6DTSS6XCgDMCqCSqGqvSMoALF0ID0RBdNowmbtZhBvmcJPD7RdOFcSDdFRKNuNGGqRcbtZ7Rt7ffKwD0A8rhkGtvqNf6goGLb6jWGRCSzbx+ABBdDsBnnaOMRxpCBgXoAXSAA"> </iframe>

## Exercise 3 {-}

**How could you change the return value of randomUI() to make the display more attractive?**

1. Placing the Go button before the returned values.
2. Use `bslib::value_box()`.

```{r eval=FALSE}
randomUI <- function(id, title) {
  ns <- NS(id)
  tagList(
    actionButton(ns("go"), "Go!"),
    value_box(title = title,
              value = textOutput(ns("val"))
    )
  )
}
```

## Exercise 3 {-}

**How could you change the return value of randomUI() to make the display more attractive?**

3. Changes the layout to show a grid.

```{r eval=FALSE}
ui <- page_fluid(
  layout_column_wrap(
    width = 1/2, height = 450,
    randomUI("num1", "Number 1"), 
    randomUI("num2", "Number 2"), 
    randomUI("num3", "Number 3"),
    randomUI("num4", "Number 4")
  )
)
```

## Exercise 3 (Shinylive) {-}

<iframe height="500" width="100%" frameborder="no" src="https://shinylive.io/r/app/#code=NobwRAdghgtgpmAXGKAHVA6ASmANGAYwHsIAXOMpMAGwEsAjAJykYE8AKAZwAtaJWAlAB0IdJiw71OY4RBEBiAAQBZIgBMArtTicRI5hDVEYAVQCSigDwBaRQDMNEAqVol2tNbkUvS2gYpARRUUITitbADkAZXc1WWDSKABzABlaTlJ2IODFKGdXCAAhDVJSN1CssCSiITABL1qAcSIAQlr67OCANyhqDTgAfXoiAA92H21FAF5vWl84XE6c5eWevrhp7zgR0gB5EtQS9gratfb4nIvZAF89CAMjGCi4Ri6X8PtHfLcPf0CIYIwdRaODPV4vWJeBxOFw-CCHUheIgHEpeTg6TgFP5LB4fOBvMhYOB5FxvdzwkoAEmqaNgqG07AAjAAGZleRkCC7BZGkBGUtYfRgUNQvAAq20yD3YnOy1xudwUKigfFy6DuGloH1QyUGdj6HiyAMU1CgrB5A2IfRgEAGAHdmKhDctbR5SNxNoyAPQAJi83DgtCS3FImwALABWNk4qCGYzmSoQDQwRm1BpgCJJ+jvFN1BpG4IPONmBNJ72pxS1DMwLOMRRl3MV-OKQumYu1RMwADM5crmfe3dz0djrZLMFDPfTfdr47q2VkshE6PBtZsnxhBXJCKRKMRinRnExJGxRpbYLejFHOYup5e59H9evMceZ4h7aTA8fw5fF7fY-aIluORQl4fgAEF0HYDU0VvF5-EbMBrgAXSAA"> </iframe>

## Links to examples {-}

Two versions of a simple app based on Tidy Tuesday data:
* [Shiny dashboard](https://github.com/jakelawlor/Volcano_Shiny_App)
* [golem with modules](https://github.com/bios2/shiny_volcano_golem)
https://github.com/deepshamenghani/Demystifying_Shiny_modules
https://github.com/hypebright/shinyconf2024-shiny101


## Meeting Videos

### Cohort 1

`r knitr::include_url("https://www.youtube.com/embed/KrBuLk4VfsU")`

<details>
  <summary> Meeting chat log </summary>
  
```
00:03:51	Federica Gazzelloni:	hello!
00:13:14	Andrew MacDonald (he/him):	https://github.com/jakelawlor/Volcano_Shiny_App
00:13:30	Andrew MacDonald (he/him):	https://github.com/bios2/shiny_volcano_golem
01:03:04	Layla Bouzoubaa:	Everyone, I need to hop off for a 1pm!! Thanks Andrew <- NS(MacDonald)!!
01:03:18	Andrew MacDonald (he/him):	yw!
01:03:47	Federica Gazzelloni:	great!
```
</details>

### Cohort 2

`r knitr::include_url("https://www.youtube.com/embed/5YmZiyVgUeg")`

`r knitr::include_url("https://www.youtube.com/embed/BTpK8lan97E")`

<details>
  <summary> Meeting chat log </summary>
  
```
00:43:20	Kevin Gilds:	https://github.com/bios2/shiny_volcano_golem
```
</details>


### Cohort 3

`r knitr::include_url("https://www.youtube.com/embed/O1Fe_IHWcS0")`

<details>
  <summary>Meeting chat log</summary>
```
00:52:06	Oluwafemi Oyedele:	https://shiny.rstudio.com/articles/modules.html
00:52:25	Oluwafemi Oyedele:	https://engineering-shiny.org/structuring-project.html
```
</details>


### Cohort 4

`r knitr::include_url("https://www.youtube.com/embed/f5nWPY3jYAM")`

<details>
  <summary>Meeting chat log</summary>
```
00:06:51	Lydia Gibson:	Hello
00:08:33	Trevin Flickinger:	https://www.youtube.com/watch?v=F6I_jXPWFBk
00:09:42	Trevin Flickinger:	https://engineering-shiny.org/structuring-project.html?q=module#using-shiny-modules
00:10:34	Lydia Gibson:	I attended Shiny conf 2023 but didn’t get to attend a lot of talk
00:48:53	Matthew Efoli:	interesting!
```
</details>


### Cohort 5

`r knitr::include_url("https://www.youtube.com/embed/URL")`

<details>
  <summary>Meeting chat log</summary>
```
LOG
```
</details>
